name: SERVER

on:
  push:
    branches:
      - 'main'
    paths:
      - 'server/**'
  workflow-dispatch: {}

jobs:
  test-server-local:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout 🛎️
        uses: actions/checkout@v3

      - name: Create user config file 🛠
        run: ./server/config-generator.sh localhost

      - name: Install Python 3.10 🐍
        uses: actions/setup-python@v3
        with:
          python-version: '3.10'

      - name: Install PostgreSQL 🐘
        run: |
          apt-get install wget ca-certificates
          wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | apt-key add -
          echo "deb http://apt.postgresql.org/pub/repos/apt/ `lsb_release -cs`-pgdg main" >> /etc/apt/sources.list.d/pgdg.list
          apt update && apt-get install -y postgresql-13 postgresql-client-13 postgis postgresql-13-postgis-3 gdal-bin
          pg_ctlcluster 13 main start

      - name: Run initializing script 📜
        run: cd ./server && POSTGRES_ADMIN=postgres ./init-local.sh ./config.env

      - name: Run server tests 🧪
        run: cd ./server && ./init-local.sh ./config.env test

  test-server-docker:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout 🛎️
        uses: actions/checkout@v3
        
      - uses: KengoTODA/actions-setup-docker-compose@v1.0.3
        with:
          version: v2.2.3

      - name: Create user config file 🛠
        run: cd server && ./config-generator.sh localhost
        
      - name: Run server in Docker 📥
        run: cd server && sudo docker-compose -f ./docker/docker-compose.yml --env-file=./docker/.env.development up --build -d
    
      - name: Install Newman for API testing 🧑‍🚀
        run: npm install newman
        
      - name: Wait for server to start ⏱
        uses: ifaxity/wait-on-action@v1
        with:
          delay: 30000
          interval: 1000
          log: true
          timeout: 150000
          resource: http://localhost:8000/healthcheck

      - name: Run API tests 🌐
        run: cd ./server/tests && newman run ./HogWeedGoAPI.postman_collection.json
        
      - name: Stop server container 📤
        run: cd server && sudo docker-compose -f ./docker/docker-compose.yml --env-file=./docker/.env.development stop -t 30

  publish-server-image:
    runs-on: ubuntu-latest
    needs: [test-server-local, test-server-docker]
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout 🛎️
        uses: actions/checkout@v3

      - name: Log in to the Container registry
        uses: docker/login-action@v1.14.1
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata (tags, labels) for Docker
        id: meta
        uses: docker/metadata-action@v3.7.0
        with:
          images: ghcr.io/${{ github.repository }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v2.10.0
        with:
          context: ./server/
          file: ./server/docker/Dockerfile-alpine
          build-args: |
            WORKDIR=app
            HOGWEED_PORT=3000
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
